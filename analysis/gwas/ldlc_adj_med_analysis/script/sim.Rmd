---
title: "LDL analysis - Adjustment of medication status"
output: html_notebook
---

# Background 
- There is currently no approach to fully adjust for medication status in lipid traits like LDL cholesterol 
- Predominantly, studies have excluded participants based on medication use associated with the phenotype of interest. However, collider bias can arise as a result of unadjustment or adjustment of the observed values due to other non-LDLc genetic factors that influence LDL-lowering medication use

# Simulation 
Load relevant packages 
```{r}
library(dplyr)
library(ggplot2)
```

Generate data 
```{r}
nid <- 100000
g <- rnorm(nid)
g_other <- rnorm(nid)
mean_ldl <- 3.56
sd_ldl <- 0.87
med_effect <- 0.8
b_omed <- 0.5

generate_data <- function(nid, mean_ldl, sd_ldl,b_gy, b_gother) {
  mean_ldl <- mean_ldl
  sd_ldl <- sd_ldl
  b_gy <- rnorm(nid, b_gy)
  b_gother <- rnorm(nid, b_gother)
  dat <- data.frame(
  mean_ldl = mean_ldl,
  sd_ldl = sd_ldl,
  b_gy = b_gy,
  b_gother = b_gother
  )
  
  return(dat)
}
```

Medication use - Calculate the probability of medication use based on prevalence 
```{r}
medication_prevalence <- 0.13

med_prob <- function(g_other, b_omed) {
  plogis(qlogis(medication_prevalence) + g_other * b_omed)
}

med_use_prob <- med_prob(g_other, b_omed)

medication_use <- rbinom(nid, 1, med_use_prob)

mean_medication_use <- mean(medication_use)
print(mean_medication_use)
```

Estimate genetic effects of non-LDL cholesterol 
```{r}
est_effs <- function(dat, med_effect, medication_use) {
  y <- mean_ldl + g * dat$b_gy + rnorm(nrow(dat), sd = sqrt(dat$sd_ldl^2 - dat$b_gy^2))
 y_obs <- y
 y_obs[as.logical(medication_use)] <- y_obs[as.logical(medication_use)] * med_effect
 y_adj_true <- y_obs
 y_adj_true[as.logical(medication_use)] <- y_obs[as.logical(medication_use)] / med_effect
 y_adj_approx <- y_obs
 y_adj_approx[as.logical(medication_use)] <- y_obs[as.logical(medication_use)] + 20
  
  results <- rbind(
  summary(lm(y ~ g_other))$coef[2,],
  summary(lm(y_obs ~ g_other))$coef[2,],
  summary(lm(y_adj_true ~ g_other))$coef[2,],
  summary(lm(y_adj_approx ~ g_other))$coef[2,]
) %>% as_tibble() %>% mutate(measure=c("y", "y_obs", "y_adj_true", "y_adj_approx"))
  
  return(results)
}

```

Create parameter grid 
```{r}
param <- expand.grid(
  nsim = 1:1000,
  nid = 10000,
  b_gy = c(0.5, 1),
  b_gother = c(0.5, 1)
)
```

Apply data generation and estimation to each parameter combination
```{r}
all_results <- list()

all_results <- lapply(1:nrow(param), function(i) {
  d <- generate_data(
    nid = param$nid[i],
    mean_ldl = 3.55595,
    sd_ldl = 0.870798,
    b_gy = param$b_gy[i],
    b_gother = param$b_gother[i]
  )
  r <- est_effs(d, med_effect, medication_use)
  return(r)
})
```

Organise results
```{r}
for (i in seq_along(all_results)) {
  attr(all_results[[i]], "Estimate") <- param$Estimate[i]
  attr(all_results[[i]], "Std. Error") <- param$Std.Error[i]
  attr(all_results[[i]], "measure") <- param$measure[i]
}

# Convert the list of results to a single data frame
all_results_df <- bind_rows(all_results)

# Calculate the mean estimated coefficient and standard error for each measure
summary_results <- all_results_df %>%
  group_by(measure) %>%
  summarise(mean_estimate = mean(Estimate),
            mean_se = sum(`Std. Error`) / 1000
            )

# Order of measures for the forest plot
measure_order <- c("y", "y_obs", "y_adj_approx", "y_adj_true")

# Create a forest plot
ggplot(summary_results, aes(x = mean_estimate, y = measure)) +
  geom_point(size = 3, color = "blue") +
  geom_errorbarh(aes(xmin = mean_estimate - 1.96 * mean_se, xmax = mean_estimate + 1.96 * mean_se), height = 0.2) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray", size = 1) +
  labs(title = "Forest plot of the effects of LDL cholesterol on non-LDL cholesterol genotype",
       subtitle = paste("Based on", 1000, "simulations"),
       x = "Estimated Coefficient",
       y = "Measure") +
  scale_y_discrete(limits = rev(measure_order)) +
  xlim(-1,1.5) +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank())
```
# Summary 
