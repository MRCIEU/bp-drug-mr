---
title: "LDL analysis - Adjustment of medication status"
output: html_notebook
---

# Background 
- There is currently no approach to fully adjust for medication status in lipid traits like LDL cholesterol 
- Predominantly, studies have excluded participants based on medication use associated with the phenotype of interest. However, collider bias can arise as a result of unadjustment or adjustment of the observed values due to other non-LDLc genetic factors that influence LDL-lowering medication use

# Simulation 
Load relevant packages 
```{r}
library(dplyr)
library(ggplot2)
```

Generate data 
```{r}
nid <- 100000
g <- rnorm(nid)
g_other <- rnorm(nid)
mean_ldl <- 3.56
sd_ldl <- 0.87
med_effect <- 0.8
b_omed <- 0.5

generate_data <- function(nid, mean_ldl, sd_ldl,b_gy, b_gother) {
  mean_ldl <- mean_ldl
  sd_ldl <- sd_ldl
  b_gy <- rnorm(nid, b_gy)
  b_gother <- rnorm(nid, b_gother)
  dat <- data.frame(
  mean_ldl = mean_ldl,
  sd_ldl = sd_ldl,
  b_gy = b_gy,
  b_gother = b_gother
  )
  
  return(dat)
}
```

Medication use - Calculate the probability of medication use based on prevalence 
```{r}
medication_prevalence <- 0.13

med_prob <- function(g_other, b_omed) {
  plogis(qlogis(medication_prevalence) + g_other * b_omed)
}

med_use_prob <- med_prob(g_other, b_omed)

medication_use <- rbinom(nid, 1, med_use_prob)

mean_medication_use <- mean(medication_use)
print(mean_medication_use)
```
Estimate genetic effects of LDL cholesterol
```{r}
est_effs_1 <- function(dat, med_effect, medication_use) {
  y <- mean_ldl + g * dat$b_gy + rnorm(nrow(dat), sd = sqrt(dat$sd_ldl^2 - dat$b_gy^2))
 y_obs <- y
 y_obs[as.logical(medication_use)] <- y_obs[as.logical(medication_use)] * med_effect
 y_adj_true <- y_obs
 y_adj_true[as.logical(medication_use)] <- y_obs[as.logical(medication_use)] / med_effect
 y_adj_approx <- y_obs
 y_adj_approx[as.logical(medication_use)] <- y_obs[as.logical(medication_use)] + 20
  
  results_1 <- rbind(
  summary(lm(y ~ g))$coef[2,],
  summary(lm(y_obs ~ g))$coef[2,],
  summary(lm(y_adj_true ~ g))$coef[2,],
  summary(lm(y_adj_approx ~ g))$coef[2,]
) %>% as_tibble() %>% mutate(measure=c("y", "y_obs", "y_adj_true", "y_adj_approx"))
  
  return(results_1)
}
```

Estimate genetic effects of non-LDL cholesterol 
```{r}
est_effs_2 <- function(dat, med_effect, medication_use) {
  y <- mean_ldl + g * dat$b_gy + rnorm(nrow(dat), sd = sqrt(dat$sd_ldl^2 - dat$b_gy^2))
 y_obs <- y
 y_obs[as.logical(medication_use)] <- y_obs[as.logical(medication_use)] * med_effect
 y_adj_true <- y_obs
 y_adj_true[as.logical(medication_use)] <- y_obs[as.logical(medication_use)] / med_effect
 y_adj_approx <- y_obs
 y_adj_approx[as.logical(medication_use)] <- y_obs[as.logical(medication_use)] + 20
  
  results_2 <- rbind(
  summary(lm(y ~ g_other))$coef[2,],
  summary(lm(y_obs ~ g_other))$coef[2,],
  summary(lm(y_adj_true ~ g_other))$coef[2,],
  summary(lm(y_adj_approx ~ g_other))$coef[2,]
) %>% as_tibble() %>% mutate(measure=c("y", "y_obs", "y_adj_true", "y_adj_approx"))
  
  return(results_2)
}
```

Create parameter grid 
```{r}
param <- expand.grid(
  nsim = 1:1000,
  nid = 10000,
  b_gy = c(0.5, 1),
  b_gother = c(0.5, 1)
)
```

Apply data generation and estimation to each parameter combination
```{r}
all_results_1 <- list()

all_results_1 <- lapply(1:nrow(param), function(i) {
  d <- generate_data(
    nid = param$nid[i],
    mean_ldl = 3.55595,
    sd_ldl = 0.870798,
    b_gy = param$b_gy[i],
    b_gother = param$b_gother[i]
  )
  r1 <- est_effs_1(d, med_effect, medication_use)
  return(r1)
})

all_results_2 <- list()

all_results_2 <- lapply(1:nrow(param), function(i) {
  d <- generate_data(
    nid = param$nid[i],
    mean_ldl = 3.55595,
    sd_ldl = 0.870798,
    b_gy = param$b_gy[i],
    b_gother = param$b_gother[i]
  )
  r2 <- est_effs_2(d, med_effect, medication_use)
  return(r2)
})
```

Organise results
```{r}
for (i in seq_along(all_results_1)) {
  attr(all_results_1[[i]], "Estimate") <- param$Estimate[i]
  attr(all_results_1[[i]], "Std. Error") <- param$Std.Error[i]
  attr(all_results_1[[i]], "measure") <- param$measure[i]
}

for (i in seq_along(all_results_2)) {
  attr(all_results_2[[i]], "Estimate") <- param$Estimate[i]
  attr(all_results_2[[i]], "Std. Error") <- param$Std.Error[i]
  attr(all_results_2[[i]], "measure") <- param$measure[i]
}

# Convert the list of results to a single data frame
all_results_df_1 <- bind_rows(all_results_1)
all_results_df_2 <- bind_rows(all_results_2)

# Calculate the mean estimated coefficient and standard error for each measure
summary_results_1 <- all_results_df_1 %>%
  group_by(measure) %>%
  summarise(mean_estimate = mean(Estimate),
            mean_se = sum(`Std. Error`) / 1000
            )

summary_results_2 <- all_results_df_2 %>%
  group_by(measure) %>%
  summarise(mean_estimate = mean(Estimate),
            mean_se = sum(`Std. Error`) / 1000
            )

# Order of measures for the forest plot
measure_order <- c("y", "y_obs", "y_adj_approx", "y_adj_true")

# Create a forest plot
ggplot(summary_results_1, aes(x = mean_estimate, y = measure)) +
  geom_point(size = 3, color = "blue") +
  geom_errorbarh(aes(xmin = mean_estimate - 1.96 * mean_se, xmax = mean_estimate + 1.96 * mean_se), height = 0.2) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray", size = 1) +
  labs(title = "Forest plot of the effects of LDL cholesterol on LDL cholesterol genotype",
       subtitle = paste("Based on", 1000, "simulations"),
       x = "Estimated Coefficient",
       y = "Measure") +
  scale_y_discrete(limits = rev(measure_order)) +
  xlim(-1,1.5) +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank())

ggplot(summary_results_2, aes(x = mean_estimate, y = measure)) +
  geom_point(size = 3, color = "blue") +
  geom_errorbarh(aes(xmin = mean_estimate - 1.96 * mean_se, xmax = mean_estimate + 1.96 * mean_se), height = 0.2) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray", size = 1) +
  labs(title = "Forest plot of the effects of LDL cholesterol on non-LDL cholesterol genotype",
       subtitle = paste("Based on", 1000, "simulations"),
       x = "Estimated Coefficient",
       y = "Measure") +
  scale_y_discrete(limits = rev(measure_order)) +
  xlim(-1,1.5) +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank())
```
# Summary
- By adjusting for medication usage in observed LDL values, the simulation shows an attenuation in genetic effect estimates. 
- Collider bias induced a negative association between unadjusted LDLc values and non-LDLc genetic factors, and a positive association between adjusted LDLc and non-LDLc genetic factors. 

```{r}
sessionInfo()
```
R version 4.2.1 (2022-06-23 ucrt)
Platform: x86_64-w64-mingw32/x64 (64-bit)
Running under: Windows 10 x64 (build 19045)

Matrix products: default

locale:
[1] LC_COLLATE=English_United Kingdom.utf8  LC_CTYPE=English_United Kingdom.utf8    LC_MONETARY=English_United Kingdom.utf8 LC_NUMERIC=C                           
[5] LC_TIME=English_United Kingdom.utf8    

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] ggplot2_3.4.2 dplyr_1.1.2  

loaded via a namespace (and not attached):
 [1] bslib_0.5.0        jquerylib_0.1.4    pillar_1.9.0       compiler_4.2.1     RColorBrewer_1.1-3 tools_4.2.1        digest_0.6.31      jsonlite_1.8.5     evaluate_0.21     
[10] lifecycle_1.0.3    tibble_3.2.1       gtable_0.3.3       nlme_3.1-157       lattice_0.20-45    mgcv_1.8-40        pkgconfig_2.0.3    rlang_1.1.0        Matrix_1.5-4.1    
[19] cli_3.6.1          rstudioapi_0.14    yaml_2.3.7         xfun_0.39          fastmap_1.1.1      withr_2.5.0        knitr_1.43         sass_0.4.6         generics_0.1.3    
[28] vctrs_0.6.1        grid_4.2.1         tidyselect_1.2.0   glue_1.6.2         R6_2.5.1           fansi_1.0.4        rmarkdown_2.22     farver_2.1.1       magrittr_2.0.3    
[37] scales_1.2.1       htmltools_0.5.5    splines_4.2.1      colorspace_2.1-0   labeling_0.4.2     utf8_1.2.3         munsell_0.5.0      cachem_1.0.8       crayon_1.5.2 
